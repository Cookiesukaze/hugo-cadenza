document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".search-form");t.forEach(e=>{e.addEventListener("submit",function(e){e.preventDefault();const n=this.querySelector(".search-field"),t=n.value.trim();t&&(window.location.href=`/search/?q=${encodeURIComponent(t)}`)})});const n=new URLSearchParams(window.location.search),e=n.get("q");e&&document.querySelector("#search-results")&&(document.querySelector("#search-query").textContent=e,performSearch(e))});function performSearch(e){const n=document.querySelector("#search-results"),t=document.querySelector("#search-loading");if(!n)return;t&&(t.style.display="block"),fetch("/index.json").then(e=>e.json()).then(n=>{const{searchType:i,searchTerm:o,constraints:a}=parseSearchQuery(e);let s=[];if(i==="multi")s=n,a.forEach(e=>{switch(e.type){case"category":s=s.filter(t=>!!t.section&&t.section.toLowerCase().includes(e.term.toLowerCase()));break;case"title":s=s.filter(t=>t.title.toLowerCase().includes(e.term.toLowerCase()));break;case"content":s=s.filter(t=>!!t.content&&t.content.toLowerCase().includes(e.term.toLowerCase()));break;case"tag":s=s.filter(t=>!!(t.tags&&Array.isArray(t.tags))&&t.tags.some(t=>t.toLowerCase().includes(e.term.toLowerCase())));break;default:s=s.filter(t=>!!t.title.toLowerCase().includes(e.term.toLowerCase())||!!(t.content&&t.content.toLowerCase().includes(e.term.toLowerCase()))||!!(t.section&&t.section.toLowerCase().includes(e.term.toLowerCase()))||!!(t.tags&&Array.isArray(t.tags))&&t.tags.some(t=>t.toLowerCase().includes(e.term.toLowerCase())))}});else switch(i){case"category":s=searchCategories(n,o);break;case"title":s=searchTitles(n,o);break;case"content":s=searchContents(n,o);break;case"tag":s=searchTags(n,o);break;default:s=searchAll(n,o)}displayResults(s,i,o,a),t&&(t.style.display="none")}).catch(e=>{console.error("搜索出错:",e),n.innerHTML='<p class="search-error">搜索时发生错误，请稍后再试。</p>',t&&(t.style.display="none")})}function parseSearchQuery(e){const n=e.trim().split(/\s+/),t=[];return n.forEach(e=>{e.startsWith("#")?t.push({type:"tag",term:e.substring(1).trim()}):e.startsWith("@")?t.push({type:"category",term:e.substring(1).trim()}):e.startsWith("!")?t.push({type:"title",term:e.substring(1).trim()}):e.startsWith("~")?t.push({type:"content",term:e.substring(1).trim()}):t.push({type:"all",term:e.trim()})}),t.length===0?{searchType:"all",searchTerm:e.trim(),constraints:[{type:"all",term:e.trim()}]}:t.length===1?{searchType:t[0].type,searchTerm:t[0].term,constraints:t}:{searchType:"multi",searchTerm:e.trim(),constraints:t}}function searchCategories(e,t){const n=t.toLowerCase();return e.filter(e=>{if(e.section&&e.section.toLowerCase().includes(n))return!0;if(e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n)))return!0;if(e.title&&e.title.toLowerCase().includes(n))return!0;if(e.parent&&e.parent.toLowerCase().includes(n))return!0;if(e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n)))return!0;if(e.permalink){const t=new URL(e.permalink).pathname;if(t.toLowerCase().includes("/"+n+"/"))return!0;const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n)return!0}return!!(e.url&&e.url.toLowerCase().includes(n))||!!(e.relpermalink&&e.relpermalink.toLowerCase().includes(n))||!!(e.path&&e.path.toLowerCase().includes(n))})}function searchTitles(e,t){const n=t.toLowerCase();return e.filter(e=>e.title.toLowerCase().includes(n))}function searchContents(e,t){const n=t.toLowerCase();return e.filter(e=>!!e.content&&e.content.toLowerCase().includes(n))}function searchTags(e,t){const n=t.toLowerCase();return e.filter(e=>!!(e.tags&&Array.isArray(e.tags))&&e.tags.some(e=>e.toLowerCase().includes(n)))}function searchAll(e,t){const n=t.toLowerCase();return e.filter(e=>{if(e.title&&e.title.toLowerCase().includes(n))return!0;if(e.content&&e.content.toLowerCase().includes(n))return!0;if(e.summary&&e.summary.toLowerCase().includes(n))return!0;if(e.section&&e.section.toLowerCase().includes(n))return!0;if(e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n)))return!0;if(e.parent&&e.parent.toLowerCase().includes(n))return!0;if(e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n)))return!0;if(e.permalink){const t=new URL(e.permalink).pathname;if(t.toLowerCase().includes("/"+n+"/"))return!0;const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n)return!0}return!!(e.relpermalink&&e.relpermalink.toLowerCase().includes(n))||!!(e.path&&e.path.toLowerCase().includes(n))||!!(e.tags&&Array.isArray(e.tags)&&e.tags.some(e=>e.toLowerCase().includes(n)))})}function displayResults(e,t,n,s){const c=document.querySelector("#search-results");if(e.length===0){if(t==="multi"){const e=s.map(e=>e.type==="tag"?`#${e.term}`:e.type==="category"?`@${e.term}`:e.type==="title"?`!${e.term}`:e.type==="content"?`~${e.term}`:e.term).join(" ");c.innerHTML=`<p class="search-no-results">没有找到与 "${e}" 相关的结果。</p>`}else c.innerHTML=`<p class="search-no-results">没有找到与 "${n}" 相关的${getSearchTypeName(t)}。</p>`;return}e.sort((e,o)=>{let i=0,a=0;return t==="multi"&&s?s.forEach(t=>{if((t.type==="title"||t.type==="all")&&(e.title.toLowerCase().includes(t.term.toLowerCase())&&(i+=3),o.title.toLowerCase().includes(t.term.toLowerCase())&&(a+=3)),(t.type==="tag"||t.type==="all")&&(e.tags&&e.tags.some(e=>e.toLowerCase().includes(t.term.toLowerCase()))&&(i+=2),o.tags&&o.tags.some(e=>e.toLowerCase().includes(t.term.toLowerCase()))&&(a+=2)),t.type==="category"||t.type==="all"){const n=t.term.toLowerCase();if(e.section&&e.section.toLowerCase().includes(n)&&(i+=1),o.section&&o.section.toLowerCase().includes(n)&&(a+=1),e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n))&&(i+=2),o.categories&&Array.isArray(o.categories)&&o.categories.some(e=>e.toLowerCase().includes(n))&&(a+=2),e.title&&e.title.toLowerCase().includes(n)&&(i+=1),o.title&&o.title.toLowerCase().includes(n)&&(a+=1),e.parent&&e.parent.toLowerCase().includes(n)&&(i+=2),o.parent&&o.parent.toLowerCase().includes(n)&&(a+=2),e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n))&&(i+=2),o.ancestors&&Array.isArray(o.ancestors)&&o.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n))&&(a+=2),e.permalink){const t=new URL(e.permalink).pathname;t.toLowerCase().includes("/"+n+"/")&&(i+=1);const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n){i+=1;break}}if(o.permalink){const e=new URL(o.permalink).pathname;e.toLowerCase().includes("/"+n+"/")&&(a+=1);const t=e.split("/").filter(e=>e);for(const e of t)if(e.toLowerCase()===n){a+=1;break}}e.relpermalink&&e.relpermalink.toLowerCase().includes(n)&&(i+=1),o.relpermalink&&o.relpermalink.toLowerCase().includes(n)&&(a+=1),e.path&&e.path.toLowerCase().includes(n)&&(i+=1),o.path&&o.path.toLowerCase().includes(n)&&(a+=1)}(t.type==="content"||t.type==="all")&&(e.content&&e.content.toLowerCase().includes(t.term.toLowerCase())&&(i+=1),o.content&&o.content.toLowerCase().includes(t.term.toLowerCase())&&(a+=1))}):(e.title.toLowerCase().includes(n.toLowerCase())&&(i+=3),o.title.toLowerCase().includes(n.toLowerCase())&&(a+=3),e.tags&&e.tags.some(e=>e.toLowerCase().includes(n.toLowerCase()))&&(i+=2),o.tags&&o.tags.some(e=>e.toLowerCase().includes(n.toLowerCase()))&&(a+=2)),i!==a?a-i:new Date(o.date)-new Date(e.date)});const d=(e,t,n)=>{const s=(t-1)*n,o=s+n;return e.slice(s,o)},l=new URLSearchParams(window.location.search);let o=parseInt(l.get("page"))||1,i=parseInt(l.get("per_page"))||5;o=Math.max(1,o),i=Math.max(5,Math.min(100,i));const a=Math.ceil(e.length/i);o>a&&a>0&&(o=a);const u=d(e,o,i);let r=`<p class="search-count">找到 ${e.length} 个结果</p>`;r+='<div class="search-results-list">',u.forEach(e=>{let i=n;t==="multi"&&s&&(i=s.map(e=>e.term).join(" "));let o="";if(t==="content"||t==="all")o=extractMatchedText(e.content,i);else if(t==="title")o=extractMatchedText(e.title,i);else if(t==="tag"&&e.tags)o=e.summary||e.content.substring(0,200)+"...";else if(t==="category")o=e.summary||e.content.substring(0,200)+"...";else if(t==="multi"){for(const n of s){const t=extractMatchedText(e.content,n.term);if(t){o=t;break}}o||(o=e.summary||e.content.substring(0,200)+"...")}o||(o=e.summary||"");let a="";if(e.relpermalink)a=e.relpermalink;else if(e.permalink){const t=new URL(e.permalink);a=t.pathname}r+=`
            <div class="search-result-item">
                <h3 class="search-result-title">
                    <a href="${e.permalink}">${e.title}</a>
                </h3>
                <div class="search-result-path">${a}</div>
                ${o?`<div class="search-result-matched-text">${o}</div>`:""}
            </div>
        `}),r+="</div>",a>1&&(r+=createClientPagination(o,a,i,t,n,s)),c.innerHTML=r,setTimeout(()=>{setupClientPaginationEvents()},100)}function getSearchTypeName(e){switch(e){case"category":return"分类";case"title":return"标题";case"content":return"内容";case"tag":return"标签";default:return"结果"}}function formatDate(e){const t=new Date(e);return t.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})}function extractMatchedText(e,t,n=100){if(!e||!t)return"";const r=e.toLowerCase(),c=t.toLowerCase(),a=r.indexOf(c);if(a===-1)return"";let s=Math.max(0,a-n),o=Math.min(e.length,a+t.length+n);for(;s>0&&e[s]!==" "&&e[s]!==".";)s--;for(;o<e.length&&e[o]!==" "&&e[o]!==".";)o++;let i=e.substring(s,o);s>0&&(i="..."+i),o<e.length&&(i=i+"...");const l=new RegExp(escapeRegExp(t),"gi");return i.replace(l,e=>`<mark>${e}</mark>`)}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function createClientPagination(e,t,n){const l=3,r=Math.max(1,e-l),c=Math.min(t,e+l);let a='<div class="pagination-container">';a+='<div class="pagination-controls">',a+='<div class="pagination">',e!==1?a+=`<a href="javascript:void(0);" class="pagination-item pagination-first" data-page="1" title="首页">
            <span class="pagination-icon">«</span>
        </a>`:a+=`<span class="pagination-item pagination-first disabled" title="首页">
            <span class="pagination-icon">«</span>
        </span>`,e>1?a+=`<a href="javascript:void(0);" class="pagination-item pagination-prev" data-page="${e-1}" title="上一页">
            <span class="pagination-icon">‹</span>
        </a>`:a+=`<span class="pagination-item pagination-prev disabled" title="上一页">
            <span class="pagination-icon">‹</span>
        </span>`,r>1&&(a+=`<a href="javascript:void(0);" class="pagination-item" data-page="1">1</a>`,r>2&&(a+=`<span class="pagination-item pagination-ellipsis">...</span>`));for(let t=r;t<=c;t++)t===e?a+=`<span class="pagination-item active">${t}</span>`:a+=`<a href="javascript:void(0);" class="pagination-item" data-page="${t}">${t}</a>`;return c<t&&(c<t-1&&(a+=`<span class="pagination-item pagination-ellipsis">...</span>`),a+=`<a href="javascript:void(0);" class="pagination-item" data-page="${t}">${t}</a>`),e<t?a+=`<a href="javascript:void(0);" class="pagination-item pagination-next" data-page="${e+1}" title="下一页">
            <span class="pagination-icon">›</span>
        </a>`:a+=`<span class="pagination-item pagination-next disabled" title="下一页">
            <span class="pagination-icon">›</span>
        </span>`,e!==t?a+=`<a href="javascript:void(0);" class="pagination-item pagination-last" data-page="${t}" title="末页">
            <span class="pagination-icon">»</span>
        </a>`:a+=`<span class="pagination-item pagination-last disabled" title="末页">
            <span class="pagination-icon">»</span>
        </span>`,a+="</div>",a+=`<div class="pagination-jump">
        <form class="pagination-jump-form" action="javascript:void(0);">
            <span class="pagination-jump-text">跳转到</span>
            <input type="number" class="pagination-jump-input" min="1" max="${t}" value="${e}" aria-label="页码">
            <span class="pagination-jump-text">页</span>
            <button type="submit" class="pagination-jump-button">确定</button>
        </form>
    </div>`,a+="</div>",a+=`<div class="pagination-size-selector">
        <span class="pagination-size-text">每页显示:</span>
        <div class="pagination-size-options">`,[5,10,20,50,100].forEach(e=>{a+=`<a href="javascript:void(0);" class="pagination-size-option${n===e?" active":""}" data-size="${e}">${e}</a>`}),a+=`</div>
    </div>`,a+="</div>",a}function setupClientPaginationEvents(){document.querySelectorAll(".pagination-item[data-page]").forEach(e=>{e.addEventListener("click",function(){const e=parseInt(this.getAttribute("data-page"));navigateToPage(e)})}),document.querySelector(".pagination-jump-form")?.addEventListener("submit",function(e){e.preventDefault();const n=this.querySelector(".pagination-jump-input"),t=parseInt(n.value),s=parseInt(n.max);t&&t>0&&t<=s&&navigateToPage(t)}),document.querySelectorAll(".pagination-size-option").forEach(e=>{e.addEventListener("click",function(){const e=parseInt(this.getAttribute("data-size"));navigateToPage(1,e)})})}function navigateToPage(e,t){const n=new URLSearchParams(window.location.search),s=t||n.get("per_page")||5,o=n.get("q")||"",i=`${window.location.pathname}?q=${encodeURIComponent(o)}&page=${e}&per_page=${s}`;window.location.href=i}