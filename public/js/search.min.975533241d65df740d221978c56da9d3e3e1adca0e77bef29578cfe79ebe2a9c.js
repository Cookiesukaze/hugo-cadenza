document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".search-form");t.forEach(e=>{e.addEventListener("submit",function(e){e.preventDefault();const n=this.querySelector(".search-field"),t=n.value.trim();t&&(window.location.href=`/search/?q=${encodeURIComponent(t)}`)})});const n=new URLSearchParams(window.location.search),e=n.get("q");e&&document.querySelector("#search-results")&&(document.querySelector("#search-query").textContent=e,performSearch(e))});function performSearch(e){const n=document.querySelector("#search-results"),t=document.querySelector("#search-loading");if(!n)return;t&&(t.style.display="block"),fetch("/index.json").then(e=>e.json()).then(n=>{const{searchType:i,searchTerm:o,constraints:a}=parseSearchQuery(e);let s=[];if(i==="multi")s=n,a.forEach(e=>{switch(e.type){case"category":s=s.filter(t=>!!t.section&&t.section.toLowerCase().includes(e.term.toLowerCase()));break;case"title":s=s.filter(t=>t.title.toLowerCase().includes(e.term.toLowerCase()));break;case"content":s=s.filter(t=>!!t.content&&t.content.toLowerCase().includes(e.term.toLowerCase()));break;case"tag":s=s.filter(t=>!!(t.tags&&Array.isArray(t.tags))&&t.tags.some(t=>t.toLowerCase().includes(e.term.toLowerCase())));break;default:s=s.filter(t=>!!t.title.toLowerCase().includes(e.term.toLowerCase())||!!(t.content&&t.content.toLowerCase().includes(e.term.toLowerCase()))||!!(t.section&&t.section.toLowerCase().includes(e.term.toLowerCase()))||!!(t.tags&&Array.isArray(t.tags))&&t.tags.some(t=>t.toLowerCase().includes(e.term.toLowerCase())))}});else switch(i){case"category":s=searchCategories(n,o);break;case"title":s=searchTitles(n,o);break;case"content":s=searchContents(n,o);break;case"tag":s=searchTags(n,o);break;default:s=searchAll(n,o)}displayResults(s,i,o,a),t&&(t.style.display="none")}).catch(e=>{console.error("搜索出错:",e),n.innerHTML='<p class="search-error">搜索时发生错误，请稍后再试。</p>',t&&(t.style.display="none")})}function parseSearchQuery(e){const n=e.trim().split(/\s+/),t=[];return n.forEach(e=>{e.startsWith("#")?t.push({type:"tag",term:e.substring(1).trim()}):e.startsWith("@")?t.push({type:"category",term:e.substring(1).trim()}):e.startsWith("!")?t.push({type:"title",term:e.substring(1).trim()}):e.startsWith("~")?t.push({type:"content",term:e.substring(1).trim()}):t.push({type:"all",term:e.trim()})}),t.length===0?{searchType:"all",searchTerm:e.trim(),constraints:[{type:"all",term:e.trim()}]}:t.length===1?{searchType:t[0].type,searchTerm:t[0].term,constraints:t}:{searchType:"multi",searchTerm:e.trim(),constraints:t}}function searchCategories(e,t){const n=t.toLowerCase();return e.filter(e=>{if(e.section&&e.section.toLowerCase().includes(n))return!0;if(e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n)))return!0;if(e.title&&e.title.toLowerCase().includes(n))return!0;if(e.parent&&e.parent.toLowerCase().includes(n))return!0;if(e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n)))return!0;if(e.permalink){const t=new URL(e.permalink).pathname;if(t.toLowerCase().includes("/"+n+"/"))return!0;const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n)return!0}return!!(e.url&&e.url.toLowerCase().includes(n))||!!(e.relpermalink&&e.relpermalink.toLowerCase().includes(n))||!!(e.path&&e.path.toLowerCase().includes(n))})}function searchTitles(e,t){const n=t.toLowerCase();return e.filter(e=>e.title.toLowerCase().includes(n))}function searchContents(e,t){const n=t.toLowerCase();return e.filter(e=>!!e.content&&e.content.toLowerCase().includes(n))}function searchTags(e,t){const n=t.toLowerCase();return e.filter(e=>!!(e.tags&&Array.isArray(e.tags))&&e.tags.some(e=>e.toLowerCase().includes(n)))}function searchAll(e,t){const n=t.toLowerCase();return e.filter(e=>{if(e.title&&e.title.toLowerCase().includes(n))return!0;if(e.content&&e.content.toLowerCase().includes(n))return!0;if(e.summary&&e.summary.toLowerCase().includes(n))return!0;if(e.section&&e.section.toLowerCase().includes(n))return!0;if(e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n)))return!0;if(e.parent&&e.parent.toLowerCase().includes(n))return!0;if(e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n)))return!0;if(e.permalink){const t=new URL(e.permalink).pathname;if(t.toLowerCase().includes("/"+n+"/"))return!0;const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n)return!0}return!!(e.url&&e.url.toLowerCase().includes(n))||!!(e.relpermalink&&e.relpermalink.toLowerCase().includes(n))||!!(e.path&&e.path.toLowerCase().includes(n))||!!(e.tags&&Array.isArray(e.tags)&&e.tags.some(e=>e.toLowerCase().includes(n)))})}function displayResults(e,t,n,s){const i=document.querySelector("#search-results");if(e.length===0){if(t==="multi"){const e=s.map(e=>e.type==="tag"?`#${e.term}`:e.type==="category"?`@${e.term}`:e.type==="title"?`!${e.term}`:e.type==="content"?`~${e.term}`:e.term).join(" ");i.innerHTML=`<p class="search-no-results">没有找到与 "${e}" 相关的结果。</p>`}else i.innerHTML=`<p class="search-no-results">没有找到与 "${n}" 相关的${getSearchTypeName(t)}。</p>`;return}e.sort((e,o)=>{let i=0,a=0;return t==="multi"&&s?s.forEach(t=>{if((t.type==="title"||t.type==="all")&&(e.title.toLowerCase().includes(t.term.toLowerCase())&&(i+=3),o.title.toLowerCase().includes(t.term.toLowerCase())&&(a+=3)),(t.type==="tag"||t.type==="all")&&(e.tags&&e.tags.some(e=>e.toLowerCase().includes(t.term.toLowerCase()))&&(i+=2),o.tags&&o.tags.some(e=>e.toLowerCase().includes(t.term.toLowerCase()))&&(a+=2)),t.type==="category"||t.type==="all"){const n=t.term.toLowerCase();if(e.section&&e.section.toLowerCase().includes(n)&&(i+=1),o.section&&o.section.toLowerCase().includes(n)&&(a+=1),e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n))&&(i+=2),o.categories&&Array.isArray(o.categories)&&o.categories.some(e=>e.toLowerCase().includes(n))&&(a+=2),e.title&&e.title.toLowerCase().includes(n)&&(i+=1),o.title&&o.title.toLowerCase().includes(n)&&(a+=1),e.parent&&e.parent.toLowerCase().includes(n)&&(i+=2),o.parent&&o.parent.toLowerCase().includes(n)&&(a+=2),e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n))&&(i+=2),o.ancestors&&Array.isArray(o.ancestors)&&o.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n))&&(a+=2),e.permalink){const t=new URL(e.permalink).pathname;t.toLowerCase().includes("/"+n+"/")&&(i+=1);const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n){i+=1;break}}if(o.permalink){const e=new URL(o.permalink).pathname;e.toLowerCase().includes("/"+n+"/")&&(a+=1);const t=e.split("/").filter(e=>e);for(const e of t)if(e.toLowerCase()===n){a+=1;break}}e.url&&e.url.toLowerCase().includes(n)&&(i+=1),o.url&&o.url.toLowerCase().includes(n)&&(a+=1),e.relpermalink&&e.relpermalink.toLowerCase().includes(n)&&(i+=1),o.relpermalink&&o.relpermalink.toLowerCase().includes(n)&&(a+=1),e.path&&e.path.toLowerCase().includes(n)&&(i+=1),o.path&&o.path.toLowerCase().includes(n)&&(a+=1)}(t.type==="content"||t.type==="all")&&(e.content&&e.content.toLowerCase().includes(t.term.toLowerCase())&&(i+=1),o.content&&o.content.toLowerCase().includes(t.term.toLowerCase())&&(a+=1))}):(e.title.toLowerCase().includes(n.toLowerCase())&&(i+=3),o.title.toLowerCase().includes(n.toLowerCase())&&(a+=3),e.tags&&e.tags.some(e=>e.toLowerCase().includes(n.toLowerCase()))&&(i+=2),o.tags&&o.tags.some(e=>e.toLowerCase().includes(n.toLowerCase()))&&(a+=2)),i!==a?a-i:new Date(o.date)-new Date(e.date)});let o=`<p class="search-count">找到 ${e.length} 个结果</p>`;o+='<div class="search-results-list">',e.forEach(e=>{o+=`
            <div class="search-result-item">
                <h3 class="search-result-title">
                    <a href="${e.permalink}">${e.title}</a>
                </h3>
                <div class="search-result-meta">
                    ${e.date?`<span class="search-result-date">${formatDate(e.date)}</span>`:""}
                    ${e.section?`<span class="search-result-section">${e.section}</span>`:""}
                </div>
                ${e.summary?`<div class="search-result-summary">${e.summary}</div>`:""}
                ${e.tags&&e.tags.length>0?`<div class="search-result-tags">
                        ${e.tags.map(e=>`<a href="/tags/${e.toLowerCase()}/" class="tag-cloud-item">${e}</a>`).join("")}
                    </div>`:""}
            </div>
        `}),o+="</div>",i.innerHTML=o}function getSearchTypeName(e){switch(e){case"category":return"分类";case"title":return"标题";case"content":return"内容";case"tag":return"标签";default:return"结果"}}function formatDate(e){const t=new Date(e);return t.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})}