document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".search-form");t.forEach(e=>{e.addEventListener("submit",function(e){e.preventDefault();const n=this.querySelector(".search-field"),t=n.value.trim();t&&(window.location.href=`/search/?q=${encodeURIComponent(t)}`)})});const n=new URLSearchParams(window.location.search),e=n.get("q");e&&document.querySelector("#search-results")&&(document.querySelector("#search-query").textContent=e,performSearch(e))});function performSearch(e){const n=document.querySelector("#search-results"),t=document.querySelector("#search-loading");if(!n)return;t&&(t.style.display="block"),fetch("/index.json").then(e=>e.json()).then(n=>{const{searchType:i,searchTerm:s}=parseSearchQuery(e);let o=[];switch(i){case"category":o=searchCategories(n,s);break;case"title":o=searchTitles(n,s);break;case"content":o=searchContents(n,s);break;case"tag":o=searchTags(n,s);break;default:o=searchAll(n,s)}displayResults(o,i,s),t&&(t.style.display="none")}).catch(e=>{console.error("搜索出错:",e),n.innerHTML='<p class="search-error">搜索时发生错误，请稍后再试。</p>',t&&(t.style.display="none")})}function parseSearchQuery(e){return e.startsWith("#")?{searchType:"tag",searchTerm:e.substring(1).trim()}:e.startsWith("@")?{searchType:"category",searchTerm:e.substring(1).trim()}:e.startsWith("!")?{searchType:"title",searchTerm:e.substring(1).trim()}:e.startsWith("~")?{searchType:"content",searchTerm:e.substring(1).trim()}:{searchType:"all",searchTerm:e.trim()}}function searchCategories(e,t){const n=t.toLowerCase();return e.filter(e=>!!e.section&&e.section.toLowerCase().includes(n))}function searchTitles(e,t){const n=t.toLowerCase();return e.filter(e=>e.title.toLowerCase().includes(n))}function searchContents(e,t){const n=t.toLowerCase();return e.filter(e=>!!e.content&&e.content.toLowerCase().includes(n))}function searchTags(e,t){const n=t.toLowerCase();return e.filter(e=>!!(e.tags&&Array.isArray(e.tags))&&e.tags.some(e=>e.toLowerCase().includes(n)))}function searchAll(e,t){const n=t.toLowerCase();return e.filter(e=>!!e.title.toLowerCase().includes(n)||!!(e.content&&e.content.toLowerCase().includes(n))||!!(e.section&&e.section.toLowerCase().includes(n))||!!(e.tags&&Array.isArray(e.tags))&&e.tags.some(e=>e.toLowerCase().includes(n)))}function displayResults(e,t,n){const o=document.querySelector("#search-results");if(e.length===0){o.innerHTML=`<p class="search-no-results">没有找到与 "${n}" 相关的${getSearchTypeName(t)}。</p>`;return}e.sort((e,t)=>{const s=e.title.toLowerCase().includes(n.toLowerCase())?1:0,o=t.title.toLowerCase().includes(n.toLowerCase())?1:0;if(s!==o)return o-s;const i=e.tags&&e.tags.some(e=>e.toLowerCase().includes(n.toLowerCase()))?1:0,a=t.tags&&t.tags.some(e=>e.toLowerCase().includes(n.toLowerCase()))?1:0;return i!==a?a-i:new Date(t.date)-new Date(e.date)});let s=`<p class="search-count">找到 ${e.length} 个结果</p>`;s+='<div class="search-results-list">',e.forEach(e=>{s+=`
            <div class="search-result-item">
                <h3 class="search-result-title">
                    <a href="${e.permalink}">${e.title}</a>
                </h3>
                <div class="search-result-meta">
                    ${e.date?`<span class="search-result-date">${formatDate(e.date)}</span>`:""}
                    ${e.section?`<span class="search-result-section">${e.section}</span>`:""}
                </div>
                ${e.summary?`<div class="search-result-summary">${e.summary}</div>`:""}
                ${e.tags&&e.tags.length>0?`<div class="search-result-tags">
                        ${e.tags.map(e=>`<a href="/tags/${e.toLowerCase()}/" class="tag-cloud-item">${e}</a>`).join("")}
                    </div>`:""}
            </div>
        `}),s+="</div>",o.innerHTML=s}function getSearchTypeName(e){switch(e){case"category":return"分类";case"title":return"标题";case"content":return"内容";case"tag":return"标签";default:return"结果"}}function formatDate(e){const t=new Date(e);return t.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})}