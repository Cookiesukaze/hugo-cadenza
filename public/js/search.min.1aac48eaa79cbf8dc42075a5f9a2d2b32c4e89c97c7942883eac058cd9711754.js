document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".search-form");t.forEach(e=>{e.addEventListener("submit",function(e){e.preventDefault();const n=this.querySelector(".search-field"),t=n.value.trim();t&&(window.location.href=`/search/?q=${encodeURIComponent(t)}`)})});const n=new URLSearchParams(window.location.search),e=n.get("q");e&&document.querySelector("#search-results")&&(document.querySelector("#search-query").textContent=e,performSearch(e))});function performSearch(e){const n=document.querySelector("#search-results"),t=document.querySelector("#search-loading");if(!n)return;t&&(t.style.display="block"),fetch("/index.json").then(e=>e.json()).then(n=>{const{searchType:i,searchTerm:o,constraints:a}=parseSearchQuery(e);let s=[];if(i==="multi")s=n,a.forEach(e=>{switch(e.type){case"category":s=s.filter(t=>!!t.section&&t.section.toLowerCase().includes(e.term.toLowerCase()));break;case"title":s=s.filter(t=>t.title.toLowerCase().includes(e.term.toLowerCase()));break;case"content":s=s.filter(t=>!!t.content&&t.content.toLowerCase().includes(e.term.toLowerCase()));break;case"tag":s=s.filter(t=>!!(t.tags&&Array.isArray(t.tags))&&t.tags.some(t=>t.toLowerCase().includes(e.term.toLowerCase())));break;default:s=s.filter(t=>!!t.title.toLowerCase().includes(e.term.toLowerCase())||!!(t.content&&t.content.toLowerCase().includes(e.term.toLowerCase()))||!!(t.section&&t.section.toLowerCase().includes(e.term.toLowerCase()))||!!(t.tags&&Array.isArray(t.tags))&&t.tags.some(t=>t.toLowerCase().includes(e.term.toLowerCase())))}});else switch(i){case"category":s=searchCategories(n,o);break;case"title":s=searchTitles(n,o);break;case"content":s=searchContents(n,o);break;case"tag":s=searchTags(n,o);break;default:s=searchAll(n,o)}displayResults(s,i,o,a),t&&(t.style.display="none")}).catch(e=>{console.error("搜索出错:",e),n.innerHTML='<p class="search-error">搜索时发生错误，请稍后再试。</p>',t&&(t.style.display="none")})}function parseSearchQuery(e){const n=e.trim().split(/\s+/),t=[];return n.forEach(e=>{e.startsWith("#")?t.push({type:"tag",term:e.substring(1).trim()}):e.startsWith("@")?t.push({type:"category",term:e.substring(1).trim()}):e.startsWith("!")?t.push({type:"title",term:e.substring(1).trim()}):e.startsWith("~")?t.push({type:"content",term:e.substring(1).trim()}):t.push({type:"all",term:e.trim()})}),t.length===0?{searchType:"all",searchTerm:e.trim(),constraints:[{type:"all",term:e.trim()}]}:t.length===1?{searchType:t[0].type,searchTerm:t[0].term,constraints:t}:{searchType:"multi",searchTerm:e.trim(),constraints:t}}function searchCategories(e,t){const n=t.toLowerCase();return e.filter(e=>{if(e.section&&e.section.toLowerCase().includes(n))return!0;if(e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n)))return!0;if(e.title&&e.title.toLowerCase().includes(n))return!0;if(e.parent&&e.parent.toLowerCase().includes(n))return!0;if(e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n)))return!0;if(e.permalink){const t=new URL(e.permalink).pathname;if(t.toLowerCase().includes("/"+n+"/"))return!0;const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n)return!0}return!!(e.url&&e.url.toLowerCase().includes(n))||!!(e.relpermalink&&e.relpermalink.toLowerCase().includes(n))||!!(e.path&&e.path.toLowerCase().includes(n))})}function searchTitles(e,t){const n=t.toLowerCase();return e.filter(e=>e.title.toLowerCase().includes(n))}function searchContents(e,t){const n=t.toLowerCase();return e.filter(e=>!!e.content&&e.content.toLowerCase().includes(n))}function searchTags(e,t){const n=t.toLowerCase();return e.filter(e=>!!(e.tags&&Array.isArray(e.tags))&&e.tags.some(e=>e.toLowerCase().includes(n)))}function searchAll(e,t){const n=t.toLowerCase();return e.filter(e=>{if(e.title&&e.title.toLowerCase().includes(n))return!0;if(e.content&&e.content.toLowerCase().includes(n))return!0;if(e.summary&&e.summary.toLowerCase().includes(n))return!0;if(e.section&&e.section.toLowerCase().includes(n))return!0;if(e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(n)))return!0;if(e.parent&&e.parent.toLowerCase().includes(n))return!0;if(e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(n)))return!0;if(e.permalink){const t=new URL(e.permalink).pathname;if(t.toLowerCase().includes("/"+n+"/"))return!0;const s=t.split("/").filter(e=>e);for(const e of s)if(e.toLowerCase()===n)return!0}return!!(e.relpermalink&&e.relpermalink.toLowerCase().includes(n))||!!(e.path&&e.path.toLowerCase().includes(n))||!!(e.tags&&Array.isArray(e.tags)&&e.tags.some(e=>e.toLowerCase().includes(n)))})}function displayResults(e,t,n,s){const i=document.querySelector("#search-results");if(e.length===0){if(t==="multi"){const e=s.map(e=>e.type==="tag"?`#${e.term}`:e.type==="category"?`@${e.term}`:e.type==="title"?`!${e.term}`:e.type==="content"?`~${e.term}`:e.term).join(" ");i.innerHTML=`<p class="search-no-results">没有找到与 "${e}" 相关的结果。</p>`}else i.innerHTML=`<p class="search-no-results">没有找到与 "${searchTerm}" 相关的${getSearchTypeName(t)}。</p>`;return}e.sort((e,n)=>{let o=0,i=0;return t==="multi"&&s?s.forEach(t=>{if((t.type==="title"||t.type==="all")&&(e.title.toLowerCase().includes(t.term.toLowerCase())&&(o+=3),n.title.toLowerCase().includes(t.term.toLowerCase())&&(i+=3)),(t.type==="tag"||t.type==="all")&&(e.tags&&e.tags.some(e=>e.toLowerCase().includes(t.term.toLowerCase()))&&(o+=2),n.tags&&n.tags.some(e=>e.toLowerCase().includes(t.term.toLowerCase()))&&(i+=2)),t.type==="category"||t.type==="all"){const s=t.term.toLowerCase();if(e.section&&e.section.toLowerCase().includes(s)&&(o+=1),n.section&&n.section.toLowerCase().includes(s)&&(i+=1),e.categories&&Array.isArray(e.categories)&&e.categories.some(e=>e.toLowerCase().includes(s))&&(o+=2),n.categories&&Array.isArray(n.categories)&&n.categories.some(e=>e.toLowerCase().includes(s))&&(i+=2),e.title&&e.title.toLowerCase().includes(s)&&(o+=1),n.title&&n.title.toLowerCase().includes(s)&&(i+=1),e.parent&&e.parent.toLowerCase().includes(s)&&(o+=2),n.parent&&n.parent.toLowerCase().includes(s)&&(i+=2),e.ancestors&&Array.isArray(e.ancestors)&&e.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(s))&&(o+=2),n.ancestors&&Array.isArray(n.ancestors)&&n.ancestors.some(e=>e.title&&e.title.toLowerCase().includes(s))&&(i+=2),e.permalink){const t=new URL(e.permalink).pathname;t.toLowerCase().includes("/"+s+"/")&&(o+=1);const n=t.split("/").filter(e=>e);for(const e of n)if(e.toLowerCase()===s){o+=1;break}}if(n.permalink){const e=new URL(n.permalink).pathname;e.toLowerCase().includes("/"+s+"/")&&(i+=1);const t=e.split("/").filter(e=>e);for(const e of t)if(e.toLowerCase()===s){i+=1;break}}e.relpermalink&&e.relpermalink.toLowerCase().includes(s)&&(o+=1),n.relpermalink&&n.relpermalink.toLowerCase().includes(s)&&(i+=1),e.path&&e.path.toLowerCase().includes(s)&&(o+=1),n.path&&n.path.toLowerCase().includes(s)&&(i+=1)}(t.type==="content"||t.type==="all")&&(e.content&&e.content.toLowerCase().includes(t.term.toLowerCase())&&(o+=1),n.content&&n.content.toLowerCase().includes(t.term.toLowerCase())&&(i+=1))}):(e.title.toLowerCase().includes(searchTerm.toLowerCase())&&(o+=3),n.title.toLowerCase().includes(searchTerm.toLowerCase())&&(i+=3),e.tags&&e.tags.some(e=>e.toLowerCase().includes(searchTerm.toLowerCase()))&&(o+=2),n.tags&&n.tags.some(e=>e.toLowerCase().includes(searchTerm.toLowerCase()))&&(i+=2)),o!==i?i-o:new Date(n.date)-new Date(e.date)});let o=`<p class="search-count">找到 ${e.length} 个结果</p>`;o+='<div class="search-results-list">',e.forEach(e=>{let i="";t==="multi"&&s?i=s.map(e=>e.term).join(" "):i=i;let n="";if(t==="content"||t==="all")n=extractMatchedText(e.content,i);else if(t==="title")n=extractMatchedText(e.title,i);else if(t==="tag"&&e.tags)n=e.summary||e.content.substring(0,200)+"...";else if(t==="category")n=e.summary||e.content.substring(0,200)+"...";else if(t==="multi"){for(const o of s){const t=extractMatchedText(e.content,o.term);if(t){n=t;break}}n||(n=e.summary||e.content.substring(0,200)+"...")}n||(n=e.summary||"");let a="";if(e.relpermalink)a=e.relpermalink;else if(e.permalink){const t=new URL(e.permalink);a=t.pathname}o+=`
            <div class="search-result-item">
                <h3 class="search-result-title">
                    <a href="${e.permalink}">${e.title}</a>
                </h3>
                <div class="search-result-path">${a}</div>
                ${n?`<div class="search-result-matched-text">${n}</div>`:""}
            </div>
        `}),o+="</div>",i.innerHTML=o}function getSearchTypeName(e){switch(e){case"category":return"分类";case"title":return"标题";case"content":return"内容";case"tag":return"标签";default:return"结果"}}function formatDate(e){const t=new Date(e);return t.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})}function extractMatchedText(e,t,n=100){if(!e||!t)return"";const r=e.toLowerCase(),c=t.toLowerCase(),a=r.indexOf(c);if(a===-1)return"";let s=Math.max(0,a-n),o=Math.min(e.length,a+t.length+n);for(;s>0&&e[s]!==" "&&e[s]!==".";)s--;for(;o<e.length&&e[o]!==" "&&e[o]!==".";)o++;let i=e.substring(s,o);s>0&&(i="..."+i),o<e.length&&(i=i+"...");const l=new RegExp(escapeRegExp(t),"gi");return i.replace(l,e=>`<mark>${e}</mark>`)}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}